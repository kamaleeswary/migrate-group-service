<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>BaseController.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">reports</a> &gt; <a href="../index.html" class="el_bundle">group-service</a> &gt; <a href="index.source.html" class="el_package">controllers</a> &gt; <span class="el_source">BaseController.java</span></div><h1>BaseController.java</h1><pre class="source lang-java linenums">package controllers;

import static controllers.ResponseHandler.handleResponse;

import akka.actor.ActorRef;
import akka.pattern.Patterns;
import akka.util.Timeout;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.util.concurrent.CompletableFuture;
import java.util.concurrent.CompletionStage;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;
import org.apache.commons.lang3.StringUtils;
import org.sunbird.Application;
import org.sunbird.common.exception.ActorServiceException;
import org.sunbird.common.exception.BaseException;
import org.sunbird.common.exception.ValidationException;
import org.sunbird.common.request.Request;
import play.mvc.Controller;
import play.mvc.Result;
import scala.compat.java8.FutureConverters;
import scala.concurrent.Future;
import utils.module.PrintEntryExitLog;
import utils.module.RequestMapper;
import org.sunbird.util.LoggerUtil;
import java.text.MessageFormat;


/**
 * This controller we can use for writing some common method to handel api request.
 * CompletableFuture: A Future that may be explicitly completed (setting its value and status), and
 * may be used as a CompletionStage, supporting dependent functions and actions that trigger upon
 * its completion. CompletionStage: A stage of a possibly asynchronous computation, that performs an
 * action or computes a value when another CompletionStage completes
 */
<span class="nc" id="L36">public class BaseController extends Controller {</span>
  private static final int WAIT_TIME_VALUE = 30;
  private static final String version = &quot;v1&quot;;
<span class="nc" id="L39">  protected ObjectMapper mapper = new ObjectMapper();</span>
<span class="nc" id="L40">  private static LoggerUtil logger = new LoggerUtil(ResponseHandler.class);</span>

  public int getTimeout(Request request) {
<span class="nc" id="L43">    int timeout = WAIT_TIME_VALUE;</span>
<span class="nc bnc" id="L44" title="All 4 branches missed.">    if (request != null &amp;&amp; request.getTimeout() &gt; 0) {</span>
<span class="nc" id="L45">      timeout = request.getTimeout();</span>
    }

<span class="nc" id="L48">    return timeout;</span>
  }

  protected ActorRef getActorRef(String operation) {
<span class="nc" id="L52">    return Application.getInstance().getActorRef(operation);</span>
  }

  protected boolean validate(Request request) throws BaseException {
    // All controllers can validate this.
<span class="nc" id="L57">    return false;</span>
  }

  /**
   * this method will take org.sunbird.Request and a validation function and lastly operation(Actor
   * operation) this method is validating the request and , this method is used to handle all the
   * request type which has requestBody
   *
   * @param request
   * @return
   */
  public CompletionStage&lt;Result&gt; handleRequest(Request request) {
      try {
<span class="nc" id="L70">        PrintEntryExitLog.printEntryLog(request);</span>
<span class="nc" id="L71">        validate(request);</span>
<span class="nc" id="L72">        return invoke(request);</span>
<span class="nc" id="L73">      } catch (Exception  ex) {</span>

<span class="nc" id="L75">        return CompletableFuture.supplyAsync(() -&gt; StringUtils.EMPTY)</span>
<span class="nc" id="L76">                .thenApply(result -&gt; {</span>
<span class="nc" id="L77">                  return ResponseHandler.handleFailureResponse(ex, request);</span>
                });

      }

  }

  /**
   * Responsible to handle the request and ask from actor
   *
   * @param request
   * @return CompletionStage&lt;Result&gt;
   * @throws BaseException
   */
  public CompletionStage&lt;Result&gt; invoke(Request request) throws BaseException {
<span class="nc bnc" id="L92" title="All 2 branches missed.">    if (request == null) {</span>
<span class="nc" id="L93">      handleResponse(new ValidationException.InvalidRequestData(), request);</span>
    }

<span class="nc" id="L96">    Function&lt;Object, Result&gt; fn =</span>
<span class="nc" id="L97">        new Function&lt;Object, Result&gt;() {</span>
          @Override
          public Result apply(Object object) {
<span class="nc" id="L100">            return handleResponse(object, request);</span>
          }
        };
<span class="nc" id="L103">    Timeout timeout = new Timeout(getTimeout(request), TimeUnit.SECONDS);</span>

<span class="nc" id="L105">    ActorRef actorRef = getActorRef(request.getOperation());</span>
<span class="nc bnc" id="L106" title="All 2 branches missed.">    if (actorRef != null) {</span>
<span class="nc" id="L107">      Future&lt;Object&gt; future = Patterns.ask(actorRef, request, timeout);</span>
<span class="nc" id="L108">      return FutureConverters.toJava(future).thenApplyAsync(fn);</span>
    } else {
<span class="nc" id="L110">      return CompletableFuture.supplyAsync(</span>
<span class="nc" id="L111">          () -&gt; handleResponse(new ActorServiceException.InvalidOperationName(null), request));</span>
    }
  }

  public Request createSBRequest(play.mvc.Http.Request httpReq, String operation) {
<span class="nc" id="L116">    RequestMapper requestMapper = new RequestMapper();</span>
<span class="nc" id="L117">    Request request = requestMapper.createSBRequest(httpReq);</span>
<span class="nc" id="L118">    request.setOperation(operation);</span>
<span class="nc" id="L119">    return request;</span>
  }

  public Request apiTest(play.mvc.Http.Request httpReq, String operation) {
<span class="nc" id="L123">    RequestMapper requestMapper = new RequestMapper();</span>
<span class="nc" id="L124">    Request request = requestMapper.apiTest(httpReq);</span>
<span class="nc" id="L125">    request.setOperation(operation);</span>
<span class="nc" id="L126">    return request;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>